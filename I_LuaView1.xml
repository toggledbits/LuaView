<?xml version="1.0" encoding="UTF-8"?>
<implementation>
    <functions>
        -- --------------------------------------------------------------------
        -- LuaView, Patrick H. Rigney (rigpapa). 
        -- Completely and totally open source. Contributions welcome!
        -- --------------------------------------------------------------------
        function startLuaView(dev)
            luup.log("LuaView 1.6develop-19331 starting.")
            isOpenLuup = false
            for _,v in pairs( luup.devices ) do
                if v.device_type == "openLuup" then
                    isOpenLuup = true
                    break
                end
            end
            luup.variable_set( "urn:toggledbits-com:serviceId:LuaView1", "isOpenLuup", isOpenLuup and "1" or "0", dev )
            if luup.attr_get( "device_json", dev ) ~= "D_LuaView1.json" then
                luup.log("LuaView resetting static JSON file, Luup reload necessary...")
                luup.attr_set( "device_json", "D_LuaView1.json", dev )
                luup.reload()
            end
            if luup.variable_get( "urn:toggledbits-com:serviceId:LuaView1", "AceOptions", dev ) == nil then
                luup.variable_set( "urn:toggledbits-com:serviceId:LuaView1", "AceOptions", "", dev )
            end
            luup.register_handler("LuaViewRequestHandler", "LuaView")
            return true, "OK", "LuaView"
        end
        
        function LuaViewRequestHandler( lul_request, lul_parameters, lul_outputformat )
            local isOpenLuup = luup.variable_get( "urn:toggledbits-com:serviceId:LuaView1", "isOpenLuup", dev ) or "0"
            if lul_parameters.action == "saveStartupLua" then
                local lua = lul_parameters.lua or ""
                if lua == "" or isOpenLuup ~= "0" then
                    luup.attr_set( "StartupCode", lua, 0 )
                    luup.attr_set( "encoded_lua", 0, 0 )
                else
                    local mime = require("mime")
                    luup.attr_set( "StartupCode", mime.b64( lua ), 0 )
                    luup.attr_set( "encoded_lua", 1, 0 )
                end
                luup.log("LuaView: updated startup Lua")
                return "OK", "text/plain"
             elseif lul_parameters.action == "testlua" then
                local _,err = loadstring( lul_parameters.lua or "" )
                local json = require "dkjson"
                if err then
                    return json.encode{ status=false, message=err }, "application/json"
                end
                return json.encode{ status=true, message="Lua OK" }, "application/json"
             elseif lul_parameters.action == "alive" then
                local json = require "dkjson"
                return json.encode{ status=true }, 'application/json'
             elseif lul_parameters.action == "blank" then
                return '&lt;html&gt;&lt;body bgcolor="white"&gt;Please wait... collecting data&lt;/body&gt;&lt;/html&gt;', "text/html"
             end
             return "ERROR\nInvalid request", "text/plain"
        end
    </functions>
    <startup>startLuaView</startup>
    <actionList>
    </actionList>
</implementation>
